#pragma once

#include <map>
#include <regex>
#include <string>

namespace HTTP {

int url_decode_raw(char *out, const char *in) {
    static const char tbl[256] = {
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  2,  3,  4,  5,
        6,  7,  8,  9,  -1, -1, -1, -1, -1, -1, -1, 10, 11, 12, 13, 14, 15, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, 10, 11, 12, 13, 14, 15, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1};
    char c, v1, v2, *beg = out;
    if (in != NULL) {
      while ((c = *in++) != '\0') {
        if (c == '%') {
          if ((v1 = tbl[(unsigned char)*in++]) < 0 ||
              (v2 = tbl[(unsigned char)*in++]) < 0) {
            *beg = '\0';
            return -1;
          }
          c = (v1 << 4) | v2;
        }
        c = (c == '+') ? ' ' : c; // replace + with whitespace
        *out++ = c;
      }
    }
    *out = '\0';
    return 0;
  }

  std::string url_decode(const std::string &str) {
    char* out_c_str = (char*)malloc(str.size() + 1);
    int ret = url_decode_raw(out_c_str, str.c_str());
    assert(ret == 0);
    std::string out_str{out_c_str};
    free(out_c_str);
    return out_str;
  }
} // namespace HTTP